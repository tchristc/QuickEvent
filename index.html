<script src="scripts/vue/vue.min.js"></script>
<style>
    body {
        font-family: Helvetica Neue, Arial, sans-serif;
    }
    
    polygon {
        fill: #42b983;
        opacity: .75;
    }
    
    circle {
        fill: transparent;
        stroke: #999;
    }
    
    text {
        font-family: Helvetica Neue, Arial, sans-serif;
        font-size: 10px;
        fill: #666;
    }
    
    label {
        display: inline-block;
        margin-left: 10px;
        width: 20px;
    }
    
    #raw {
        position: absolute;
        top: 0;
        left: 300px;
    }
    
    .draggable {
      cursor: move;
    }

    .animated {
      -webkit-animation-duration: 1s;
      animation-duration: 1s;
    }

    @keyframes pulse {
      from {
        -webkit-transform: scale3d(1, 1, 1);
        transform: scale3d(1, 1, 1);
      }
      50% {
        -webkit-transform: scale3d(1.05, 1.05, 1.05);
        transform: scale3d(1.05, 1.05, 1.05);
      }
      to {
        -webkit-transform: scale3d(1, 1, 1);
        transform: scale3d(1, 1, 1);
      }
    }

    .plugin {
      fill:rgba(0,0,0,.25);
      stroke:black;
      stroke-width:.5;
    }

    .plugin .animated{
      animation: pulse 1s infinite;
      transform-origin: center center;
    }
</style>
<script type="text/x-template" id="pipeline-template">
  <svg width="100%" height="100%" ref="svgCanvas" 
      @mousedown="startDrag"
      @mousemove="drag"
      @mouseup="endDrag"
      @mouseleave="endDrag">
      <plugin v-for="plugin in plugins" :plugin="plugin" ref="plugins" ></plugin>
  </svg>
</script> 
<script type="text/x-template" id="plugin-template">
  <g class="plugin">
    <g class="draggable">
        <rect x="0" ys="0" rx="5" ry="5" :width="plugin.w" :height="plugin.h"/>
        <line x1="0" y1="10" :x2="plugin.w" y2="10"></line>
        <text x="10" y="10">Component</text>      
    </g>
  </g>
</script> 

<div id="app">
  <button @click="add">add</button>
  <pipeline :plugins="plugins"></pipeline>
</div>

<script>
var plugins = [
  { x: 3, y: 3, w:100, h:50 },
  { x: 50, y:50, w:100, h:50 }
];

Vue.component('pipeline', {
  props: ['plugins', 'selectedElement', 'selectedPlugin', 'offset', 'transform', 'svg'],
  template: '#pipeline-template',
  created: function(){
    console.log('Created');
  },
  mounted: function(){
    this.svg = this.$refs.svgCanvas;
    console.log('Mounted');
  },
  updated: function(){
    this.svg = this.$refs.svgCanvas;
    console.log('Updated');
  },
  destroyed: function(){
    console.log('Destroyed');
  },
  methods: {
    getMousePosition: function (evt) {
      var CTM = this.svg.getScreenCTM();
      return {
        x: (evt.clientX - CTM.e) / CTM.a,
        y: (evt.clientY - CTM.f) / CTM.d
      };
    },
    startDrag: function (evt) {
      if (evt.target.parentElement.classList.contains('draggable')) {
        this.selectedElement = evt.target.parentElement;
        for(var k in this.$refs.plugins)
        {
          if(this.$refs.plugins[k].$el === this.selectedElement)
          {
            this.selectedPlugin = this.$refs.plugins[k];
            break;
          }
        }
        
        this.offset = this.getMousePosition(evt);

        var transforms = this.selectedElement.transform.baseVal;
        if (transforms.length === 0 || transforms.getItem(0).type !== SVGTransform.SVG_TRANSFORM_TRANSLATE) {
          var translate = this.svg.createSVGTransform();
          translate.setTranslate(0, 0);
          this.selectedElement.transform.baseVal.insertItemBefore(translate, 0);
        }

        this.transform = transforms.getItem(0);
        this.offset.x -= this.transform.matrix.e;
        this.offset.y -= this.transform.matrix.f;
        console.log('startDrag');
      }
    },
    drag: function (evt) {
      if (this.selectedElement) {
        console.log('drag');
        evt.preventDefault();
        var coord = this.getMousePosition(evt);
        this.transform.setTranslate(coord.x - this.offset.x, coord.y - this.offset.y);
      }
    },
    endDrag: function (evt) {
      this.selectedPlugin = false;
      this.selectedElement = false;
    }
  }
});

Vue.component('plugin', {
  props: ['plugin'],
  template: '#plugin-template',
  created: function(){
  },
  methods: {
  }
});

var vm = new Vue({
  el: '#app',
  data: {
    plugins: plugins
  },
  methods: {
    add: function (e) {
      e.preventDefault();
      this.plugins.push({ x: 3, y: 3, w:100, h:50 });
    },
    remove: function (stat) {
      this.plugins.splice(this.plugins.indexOf(stat), 1);
    }
  }
});
</script>