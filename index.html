<script src="scripts/vue/vue.min.js"></script>
<script type="text/x-template" id="pipeline-template">
  <svg width="100%" height="100%" ref="svgCanvas" 
      @mousedown="startDrag"
      @mousemove="drag"
      @mouseup="endDrag"
      @mouseleave="endDrag">
      <plugin v-for="data in stats" :data="data" ref="plugins"></plugin>
  </svg>
</script> 
<script type="text/x-template" id="plugin-template">
  <g :id="data.id" class="draggable" style="fill:transparent;stroke:black;stroke-width:1;">
      <rect x="0" y="0" rx="5" ry="5" :width="data.w" :height="data.h"/>
      <line x1="0" y1="10" :x2="data.w" y2="10"></line>
  </g>
</script> 

<div id="app">
  <button @click="add">add</button>
  <pipeline :stats="stats"></pipeline>
</div>

<script>
var stats = [
  { x: 3, y: 3, w:100, h:50 },
  { x: 50, y:50, w:100, h:50 }
];

Vue.component('pipeline', {
  props: ['stats', 'selectedElement', 'selectedData', 'offset', 'transform', 'svg'],
  template: '#pipeline-template',
  created: function(){
    console.log('Created');
  },
  mounted: function(){
    this.svg = this.$refs.svgCanvas;
    console.log('Mounted');
  },
  updated: function(){
    this.svg = this.$refs.svgCanvas;
    console.log('Updated');
  },
  destroyed: function(){
    console.log('Destroyed');
  },
  methods: {
    getMousePosition: function (evt) {
      var CTM = this.svg.getScreenCTM();
      return {
        x: (evt.clientX - CTM.e) / CTM.a,
        y: (evt.clientY - CTM.f) / CTM.d
      };
    },
    startDrag: function (evt) {
      if (evt.target.parentElement.classList.contains('draggable')) {
        this.selectedElement = evt.target.parentElement;
        for(var k in this.$refs.plugins)
        {
          if(this.$refs.plugins[k].$el === this.selectedElement)
          {
            this.selectedData = this.$refs.plugins[k];
          }
        }
        
        this.offset = this.getMousePosition(evt);

        var transforms = this.selectedElement.transform.baseVal;
        if (transforms.length === 0 || transforms.getItem(0).type !== SVGTransform.SVG_TRANSFORM_TRANSLATE) {
          var translate = this.svg.createSVGTransform();
          translate.setTranslate(0, 0);
          this.selectedElement.transform.baseVal.insertItemBefore(translate, 0);
        }

        this.transform = transforms.getItem(0);
        this.offset.x -= this.transform.matrix.e;
        this.offset.y -= this.transform.matrix.f;
        console.log('startDrag');
      }
    },
    drag: function (evt) {
      if (this.selectedElement) {
        console.log('drag');
        evt.preventDefault();
        var coord = this.getMousePosition(evt);
        this.transform.setTranslate(coord.x - this.offset.x, coord.y - this.offset.y);
      }
    },
    endDrag: function (evt) {
      this.selectedData = false;
      this.selectedElement = false;
    }
  }
});

Vue.component('plugin', {
  props: ['data'],
  template: '#plugin-template',
  created: function(){
  },
  methods: {
  }
});

var vm = new Vue({
  el: '#app',
  data: {
    stats: stats
  },
  methods: {
    add: function (e) {
      e.preventDefault();
      this.stats.push({ x: 3, y: 3, w:100, h:50 });
    },
    remove: function (stat) {
      this.stats.splice(this.stats.indexOf(stat), 1);
    }
  }
});
</script>

<style>
body {
    font-family: Helvetica Neue, Arial, sans-serif;
}

polygon {
    fill: #42b983;
    opacity: .75;
}

circle {
    fill: transparent;
    stroke: #999;
}

text {
    font-family: Helvetica Neue, Arial, sans-serif;
    font-size: 10px;
    fill: #666;
}

label {
    display: inline-block;
    margin-left: 10px;
    width: 20px;
}

#raw {
    position: absolute;
    top: 0;
    left: 300px;
}

.draggable {
  cursor: move;
}
</style>